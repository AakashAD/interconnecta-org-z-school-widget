<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Deal Hierarchy</title>

  <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbeddedAppSDK.min.js"></script>
  <script src="https://app-assets.web.app/widgetsdk/ZohoEmbededAppSDK.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 12px;
    }

    /* Header */
    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .widget-title {
      font-size: 16px;
      font-weight: bold;
    }

    .controls button {
      margin-left: 6px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      color: #fff;
    }

    .expand { background-color: #1e88e5; }
    .collapse { background-color: #e53935; }

    /* State Banner */
    .state-banner {
      background: #1e88e5;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 14px;
      font-weight: bold;
    }

    /* Account Cards */
    .account-card {
      background: #fff;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 6px solid #1e88e5;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .account-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }

    .account-meta {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
      padding-left: 28px;
    }

    .toggle {
      cursor: pointer;
      margin-right: 6px;
      font-weight: bold;
      background: none;
      border: none;
      font-size: 16px;
      width: 20px;
    }

    .deal-row {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px dashed #eee;
      margin-left: 28px;
    }

    .hidden { display: none; }

    /* Stage Badges */
    .stage {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
    }

    .won { background:#c8e6c9; color: #2e7d32; }
    .completed { background:#fff9c4; color: #f57f17; }
    .paid { background:#dcedc8; color: #33691e; }
    .lead { background:#e3f2fd; color: #1565c0; }

    /* Deal Status Badges (Zoho-like) */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin: 0 6px;
    }

    .status-closed-won {
      background: #e6f4ea;
      color: #1e7e34;
    }

    .status-course-completed {
      background: #fff4e5;
      color: #b45309;
    }

    .status-registered-paid {
      background: #eaf7ea;
      color: #2f7a2f;
    }

    .status-lead-received {
      background: #e8f0fe;
      color: #1a73e8;
    }

    /* Hierarchy Colors */
    .municipal-dept { border-left-color: #1e88e5; }
    .municipality { border-left-color: #43a047; }
    .county-dept { border-left-color: #8e24aa; }
    .county { border-left-color: #fb8c00; }

    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-right: 6px;
      background: #e3f2fd;
    }

    .badge.secondary { background: #f1f1f1; color: #666; }

    .deal-list.empty {
      font-size: 12px;
      color: #777;
      font-style: italic;
      padding-left: 28px;
    }

    /* Deal Summary */
    .deal-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 10px 28px;
    }

    .deal-summary .summary-box {
      background: #f5f7fa;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      color: #333;
    }

    .summary-total {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* Active summary filter */
    .summary-box.active {
      outline: 2px solid #1e88e5;
      background: #e8f0fe;
    }

    /* Deal row separators */
    .deal-sep {
      margin: 0 6px;
      color: #9aa0a6;
      font-weight: normal;
    }

    .deal-name {
      font-weight: 500;
    }

    .deal-amount {
      margin-left: 2px;
    }
      /* Separator between summary pills */
  .deal-summary .summary-box:not(:last-child)::after {
    content: "|";
    margin-left: 8px;
    color: #9aa0a6;
    font-weight: normal;
  }
  </style>



</head>

<body>

  <div class="widget-header">
    <div class="widget-title">Deal Hierarchy</div>
    <div class="controls">
      <button class="expand" onclick="expandAll()">Expand All</button>
      <button class="collapse" onclick="collapseAll()">Collapse All</button>
    </div>
  </div>

  <div class="state-banner">STATE: NEW JERSEY</div>

  <div class="account-card municipal-dept">
    <div class="account-title">
      <button class="toggle" onclick="toggleSection(event, 'acc1')">▾</button>
      Toms River Police Department
    </div>
    <div class="account-meta">
      <span class="badge">Municipal Department</span>
      <span class="badge secondary">Police Department</span>
    </div>

    <div id="acc1" class="deal-list">
      <div class="deal-row">NJ – Toms River Police Dept – ORPO – 2025-06 | <span class="stage won">Closed-Won</span> | $4,500.00</div>
      <div class="deal-row">Nicholas Lugo – SH-Training | <span class="stage completed">Course Completed</span> | $450.00</div>
      <div class="deal-row">Timothy McGarrey – SH-Training | <span class="stage paid">Registered & Paid</span> | $450.00</div>
      <div class="deal-row">James Skripko – SH-Training | <span class="stage paid">Registered & Paid</span> | $450.00</div>
    </div>
  </div>

  <!-- <div class="account-card municipality">
    <div class="account-title">
      <button class="toggle" onclick="toggleSection(event, 'acc2')">▾</button>
      Toms River Township, NJ
    </div>
    <div class="account-meta">
      <span class="badge">Municipality</span>
    </div>

    <div id="acc2" class="deal-list">
      <div class="deal-row">NJ – Toms River Township – ORPO – 2025-03 | <span class="stage won">Closed-Won</span> | $4,500.00</div>
      <div class="deal-row">NJ – Toms River Township – Training – 2025-04 | <span class="stage lead">Lead Received</span> | $6,529,500.00</div>
    </div>
  </div> -->

  <!-- <div class="account-card county">
    <div class="account-title">
      <button class="toggle" onclick="toggleSection(event, 'acc3')">▾</button>
      Ocean County
    </div>
    <div class="account-meta">
      <span class="badge">County</span>
    </div>

    <div id="acc3" class="deal-list empty">
      No deals for this account
    </div>
  </div> -->

  <script>
    let ALL_DEALS = [];
    let ACTIVE_STAGE_FILTER = null;

    /* --- UI Logic --- */
    function toggleSection(event, id) {
      const el = document.getElementById(id);
      const icon = event.target;
      if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        icon.textContent = '▾';
      } else {
        el.classList.add('hidden');
        icon.textContent = '▸';
      }
    }

    function expandAll() {
      document.querySelectorAll('.deal-list').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.toggle').forEach(t => t.textContent = '▾');
    }

    function collapseAll() {
      document.querySelectorAll('.deal-list').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.toggle').forEach(t => t.textContent = '▸');
    }

    function renderDeals(deals, container) {
      container.querySelectorAll(".deal-row").forEach(d => d.remove());

      deals.forEach(function (deal) {
        const dealName = deal.Deal_Name || "Deal";
        const rawStatus = deal.Stage || deal.$status || "N/A";
        const normalizedStatus = rawStatus.toLowerCase();
        const amount = deal.Amount || 0;
        const currency = deal.$currency_symbol || "$";

        let statusClass = "";
        if (normalizedStatus.includes("closed")) statusClass = "status-closed-won";
        else if (normalizedStatus.includes("course")) statusClass = "status-course-completed";
        else if (normalizedStatus.includes("registered")) statusClass = "status-registered-paid";
        else if (normalizedStatus.includes("lead")) statusClass = "status-lead-received";

        const row = document.createElement("div");
        row.className = "deal-row";
        row.innerHTML = `
          <span class="deal-name">${dealName}</span>
          <span class="deal-sep">|</span>
          <span class="status-badge ${statusClass}">${rawStatus}</span>
          <span class="deal-sep">|</span>
          <strong class="deal-amount">${currency}${amount.toLocaleString()}</strong>
        `;

        container.appendChild(row);
      });
    }


// Subscribe to the EmbeddedApp onPageLoad event
ZOHO.embeddedApp.on("PageLoad", function (data) {

  console.log("Page Load Data:", data);

  if (!data || !data.EntityId) {
    console.warn("No EntityId found");
    return;
  }

  const accountId = data.EntityId;

  /* ===== FETCH ACCOUNT DETAILS ===== */
  ZOHO.CRM.API.getRecord({
    Entity: "Accounts",
    RecordID: accountId,
    approved: "both"
  })
  .then(function (response) {
    console.log("Account Record Response:", response);

    if (!response.data || !response.data.length) return;

    const acc = response.data[0];

    // Exact field mapping from Accounts module
    const accountName = acc.Account_Name || "Account";
    const state = acc.State || acc.Billing_State || "N/A";
    const hierarchy = acc.Hierarchy || "N/A";
    const department = acc.Department || "";

    // Update STATE banner
    const stateBanner = document.querySelector(".state-banner");
    if (stateBanner) stateBanner.textContent = "STATE: " + state;

    // Update Account title
    const accTitle = document.querySelector(".municipal-dept .account-title");
    if (accTitle) {
      accTitle.innerHTML = `
        <button class="toggle" onclick="toggleSection(event, 'acc1')">▾</button>
        ${accountName}
      `;
    }

    // Update hierarchy badge
    const badges = document.querySelectorAll(".municipal-dept .badge");
    if (badges[0]) badges[0].textContent = hierarchy;
    if (badges[1]) badges[1].textContent = department;

  })
  .catch(function (error) {
    console.error("Error fetching account record:", error);
  });

  /* ===== FETCH DEALS RELATED LIST ===== */
  ZOHO.CRM.API.getRelatedRecords({
    Entity: "Accounts",
    RecordID: accountId,
    RelatedList: "Deals",
    page: 1,
    per_page: 200
  })
  .then(function (response) {
    console.log("Deals Related List Response:", response);

    const deals = response.data || [];
    ALL_DEALS = deals;
    const dealContainer = document.getElementById("acc1");

    if (!dealContainer) return;

    // Clear existing static rows
    dealContainer.innerHTML = "";

    // ----- DEAL COUNTS -----
    const totalDeals = deals.length;
    const stageCountMap = {};

    deals.forEach(d => {
      const stage = (d.Stage || "Unknown").toLowerCase();
      stageCountMap[stage] = (stageCountMap[stage] || 0) + 1;
    });

    // ----- SUMMARY UI -----
    const summaryDiv = document.createElement("div");
    summaryDiv.className = "deal-summary";

    // Total count
    const totalBox = document.createElement("div");
    totalBox.className = "summary-box summary-total";
    totalBox.textContent = `Total Deals: ${totalDeals}`;
    totalBox.style.cursor = "pointer";
    totalBox.onclick = function () {
      ACTIVE_STAGE_FILTER = null;

      document.querySelectorAll(".deal-summary .summary-box")
        .forEach(el => el.classList.remove("active"));

      totalBox.classList.add("active");
      renderDeals(ALL_DEALS, dealContainer);
    };
    summaryDiv.appendChild(totalBox);
    totalBox.classList.add("active");

    // Stage-wise counts
    Object.keys(stageCountMap).forEach(stageKey => {
      const box = document.createElement("div");
      box.className = "summary-box";
      box.style.cursor = "pointer";

      box.textContent =
        `${stageKey.replace(/(^\w|\s\w)/g, m => m.toUpperCase())}: ${stageCountMap[stageKey]}`;

      box.onclick = function () {
        ACTIVE_STAGE_FILTER = stageKey.toLowerCase();

        document.querySelectorAll(".deal-summary .summary-box")
          .forEach(el => el.classList.remove("active"));

        box.classList.add("active");

        const filteredDeals = ALL_DEALS.filter(d =>
          (d.Stage || "").toLowerCase().includes(ACTIVE_STAGE_FILTER)
        );

        renderDeals(filteredDeals, dealContainer);
      };

      summaryDiv.appendChild(box);
    });

    // Attach summary
    dealContainer.appendChild(summaryDiv);

    if (!deals.length) {
      dealContainer.innerHTML = "<div class='deal-list empty'>No deals for this account</div>";
      return;
    }

    renderDeals(ALL_DEALS, dealContainer);
  })
  .catch(function (error) {
    console.error("Error fetching deals:", error);
  });

});



// Initialize the widget
ZOHO.embeddedApp.init();
  </script>

</body>
</html>